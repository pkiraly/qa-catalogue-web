<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <!-- script src="//use.fontawesome.com/feff23b961.js"></script -->
    <script src="feff23b961.js"></script>
    <script src="configuration.js" type="text/javascript"></script>
    <script src="selected-facets.js" type="text/javascript"></script>
<style type="text/css">
#per-page .label {
    color: #999;
}
#query {
    border-radius: 10px;
    border-color: #37ba00;
}
#content {
    border-top: 1px solid #cccccc;
    border-radius: 10px;
}
h1 {
    color: #37ba00;
    padding: 5px;
    border-bottom: 1px solid #cccccc;
    border-radius: 10px;
    font-weight: 900;
}
h1 span {
    font-size: 80%;
    color: #333;
    font-weight: 100;
}
h3 {
    color: #37ba00;
}
.search-block {
    margin-bottom: 10px;
}
#message {
    color: #37ba00;
}
#navigation {
    border-bottom: 1px dashed #cccccc;
    margin-bottom: 15px;
}
#navigation-footer {
    border-top: 1px dashed #cccccc;
    margin-bottom: 15px;
}

#records {
    padding: 0;
    margin: 0;
    margin-top: 5px;
}
.record {
    margin-bottom: 15px;
}

.record h2 {
    margin-bottom: 0;
    font-weight: 200;
}
.record h2 .fa-book {
    color: #37ba00;
}
.record .label {
    color: #cccccc;
}
.record .similarity {
    text-align: right;
    color: #999999;
}
.record .details {
    display: none;
    margin-left: 50px;
}
ul {
    list-style-type: none;
    padding-left: 0px;
}
#numFound {
    color: #37ba00;
    font-weight: 900;
}
#solr-url {
    overflow: auto;
    overflow-wrap: break-word;
    word-break: break-all;
    color: #37ba00;
    font-size: small;
}
</style>
</head>
<body>
<div class="container">
    <!-- Content here -->
    <h1><i class="fa fa-book" aria-hidden="true"></i> Tradit catalog <span>for analysing clusters</span></h1>
    <div class="container" id="content">

        <div class="row">
            <div id="left" class="col-3">
                <div class="search-block">
                    <h3>Search</h3>
                    <form id="search">
                        <input type="text" name="query" id="query" value="*:*">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </form>
                </div>
                <div id="filters" class="filter-block">
                    <h3>Filters</h3>
                    <div id="filter-list"></div>
                </div>

                <div id="facets" class="facet-block">
                    <h3>Facets</h3>
                    <div id="facet-list"></div>
                </div>
            </div>
            <div id="main" class="col">
                <div class="row">
                    <div class="col-8">
                        Found <span id="numFound"></span> records
                    </div>
                    <div class="col-4" id="message"></div>
                </div>

                <div class="row" id="navigation">
                    <div class="col-8" id="prev-next"></div>
                    <div class="col-4" id="per-page">
                        <span class="label">Items per page:</span>
                        <span id="items-per-page"></span>
                    </div>
                </div>

                <div id="records"></div>

                <div class="row" id="navigation-footer">
                    <div class="col-8" id="prev-next-footer"></div>
                    <div class="col-4"></div>
                </div>
                <div id="solr-url"></div>
                <div class="row" id="settings">
                    <div class="col-4"><a href="#" id="set-facets">set facets</a></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="//code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
<script src="js/handlebars.min.js"></script>

<script id="list-facet-template" type="text/x-handlebars-template">
    <div id="{{machineName}}" class="facet-block">
        <h4>{{facetName}}</h4>
        {{#list facets}}<a href="#">{{term}}</a> ({{count}}){{/list}}
    </div>
</script>

<script id="record-template" type="text/x-handlebars-template">
    <div class="record">
        <h2>
            {{#if 245a_Title_mainTitle_ss}}
                {{245a_Title_mainTitle_ss}}
            {{/if}}
            {{#if 245b_Title_subtitle_ss}}
                {{245b_Title_subtitle_ss}}
            {{/if}}
            <a href="#" data="details-{{id}}"><i class="fa fa-book" aria-hidden="true"></i></a>
        </h2>
        {{#if 245c_Title_responsibilityStatement_ss}}
            <i class="fa fa-pencil" aria-hidden="true"></i> {{245c_Title_responsibilityStatement_ss}}<br/>
        {{/if}}
        {{#if 250a_Edition_editionStatement_ss}}
            {{250a_Edition_editionStatement_ss}}<br/>
        {{/if}}
        {{#if hasPublication}}
            <i class="fa fa-calendar" aria-hidden="true"></i>
            Published
            {{#if 260c_Publication_date_ss}}
                in {{260c_Publication_date_ss}}
            {{/if}}
            {{#if 260a_Publication_place_ss}}
                in {{260a_Publication_place_ss}}
            {{/if}}
            {{#if 260b_Publication_agent_ss}}
                by {{260b_Publication_agent_ss}}
            {{/if}}
            <br/>
        {{/if}}
        {{#if hasPhysicalDescription}}
            {{#if 300a_PhysicalDescription_extent_ss}}
                {{300a_PhysicalDescription_extent_ss}}
            {{/if}}
            {{#if 300c_PhysicalDescription_dimensions_ss}}
                {{300c_PhysicalDescription_dimensions_ss}}
            {{/if}}
            <br/>
        {{/if}}
        {{#if 490a_SeriesStatement_ss}}
            Series:
            <a href="#" class="record-link" data="490a_SeriesStatement_ss"
            >{{490a_SeriesStatement_ss}}</a>
            {{#if 490a_SeriesStatement_ss}}
                {{490v_SeriesStatement_volume_ss}}
            {{/if}}
            <br/>
        {{/if}}
        {{#if 520a_Summary_ss}}
            {{520a_Summary_ss}}<br/>
        {{/if}}
        {{#if 505a_TableOfContents_ss}}
            {{505a_TableOfContents_ss}}<br/>
        {{/if}}
        {{#if hasMainPersonalName}}
            <i class="fa fa-user" aria-hidden="true" title="personal name"></i>
            {{#if 100a_MainPersonalName_personalName_ss}}
                <a href="#" class="record-link" data="100a_MainPersonalName_personalName_ss"
                >{{100a_MainPersonalName_personalName_ss}}</a>
            {{/if}}
            {{#if 100d_MainPersonalName_dates_ss}}
                {{100d_MainPersonalName_dates_ss}}
            {{/if}}
            <br/>
        {{/if}}
        {{#if 700a_AddedPersonalName_personalName_ss}}
            <i class="fa fa-user" aria-hidden="true" title="personal name"></i>
            <a href="#" class="record-link" data="700a_AddedPersonalName_personalName_ss"
            >{{700a_AddedPersonalName_personalName_ss}}</a>
            {{#if 700d_AddedPersonalName_dates_ss}}
                {{700d_AddedPersonalName_dates_ss}}
            {{/if}}
            <br/>
        {{/if}}

        {{#if 710a_AddedCorporateName_ss}}
            {{710a_AddedCorporateName_ss}}
            {{#if 710d_AddedCorporateName_dates}}
                {{710d_AddedCorporateName_dates}}
            {{/if}}
            <br/>
        {{/if}}
        {{#if 650a_Topic_topicalTerm_ss}}
            <i class="fa fa-hashtag" aria-hidden="true" title="topical term"></i>
            <a href="#" class="record-link" data="650a_Topic_topicalTerm_ss"
            >{{650a_Topic_topicalTerm_ss}}</a><br/>
        {{/if}}
        {{#if 650z_Topic_geographicSubdivision_ss}}
            <i class="fa fa-map" aria-hidden="true" title="geographic subdivision"></i>
            <a href="#" class="record-link" data="650z_Topic_geographicSubdivision_ss"
            >{{650z_Topic_geographicSubdivision_ss}}</a><br/>
        {{/if}}
        {{#if 650v_Topic_formSubdivision_ss}}
            <i class="fa fa-tag" aria-hidden="true" title="form"></i>
            <a href="#" class="record-link" data="650v_Topic_formSubdivision_ss"
            >{{650v_Topic_formSubdivision_ss}}</a><br/>
        {{/if}}
        {{#if 6500_Topic_authorityRecordControlNumber_ss}}
            <a href="#" class="record-link" data="6500_Topic_authorityRecordControlNumber_ss"
            >{{6500_Topic_authorityRecordControlNumber_ss}}</a><br/>
        {{/if}}
        {{#if 6510_Geographic_authorityRecordControlNumber_ss}}
            <i class="fa fa-map" aria-hidden="true"></i>
            <a href="#" class="record-link" data="6510_Geographic_authorityRecordControlNumber_ss"
            >{{6510_Geographic_authorityRecordControlNumber_ss}}</a><br/>
        {{/if}}
        {{#if 6550_GenreForm_authorityRecordControlNumber_ss}}
            <a href="#" class="record-link" data="6550_GenreForm_authorityRecordControlNumber_ss"
            >{{6550_GenreForm_authorityRecordControlNumber_ss}}</a><br/>
        {{/if}}

        {{#if hasSimilarBooks}}
            <div class="similarity">
                <i class="fa fa-search" aria-hidden="true"></i>
                Search for similar items:
            {{#if 9129_WorkIdentifier_ss}}
                works:
                <a href="#" class="record-link" data="9129_WorkIdentifier_ss"
                >{{9129_WorkIdentifier_ss}}</a>
            {{/if}}
            {{#if 9119_ManifestationIdentifier_ss}}
                manifestations:
                <a href="#" class="record-link" data="9119_ManifestationIdentifier_ss"
                >{{9119_ManifestationIdentifier_ss}}</a>
            {{/if}}
            </div>
        {{/if}}

        <div class="details" id="details-{{id}}">
            {{#list fields}}<span class="label">{{label}}:</span> {{value}}{{/list}}
        </div>
    </div>
</script>

<script id="filter-param-template" type="text/x-handlebars-template"
>fq={{field}}:"{{value}}"</script>

<script id="list-filters-template" type="text/x-handlebars-template">
{{#list filters}}<a href="#" data="{{param}}"><i class="fa fa-minus" aria-hidden="true"></i></a> {{label}}{{/list}}
</script>

<script id="item-prev-next-template" type="text/x-handlebars-template">
<a href="#" data="{{start}}">{{label}}</a>
</script>

<script id="list-prev-next-template" type="text/x-handlebars-template">
{{#list items}}{{item}}{{/list}}
</script>

<script id="strong-template" type="text/x-handlebars-template">
<strong>{{item}}</strong>
</script>

<script type="text/javascript">
  var query = '*:*';
  var start = 0;
  var rows = 10;
  var filters = [];

  var defaultFacets = [
      '041a_Language_ss',
      '040b_AdminMetadata_languageOfCataloging_ss',
      'Leader_06_typeOfRecord_ss',
      'Leader_18_descriptiveCatalogingForm_ss'
  ];

  var facets = defaultFacets;
  if (typeof selectedFacets != 'undefined')
      facets = selectedFacets;

  var parameters = [
      'wt=json',
      'json.nl=map',
      'json.wrf=?',
      'facet=on'
      // 'facet.field=ManifestationIdentifier_ss',
      // 'facet.field=9129_WorkIdentifier_ss',
      // 'facet.field=041a_Language_ss',
      // 'facet.field=040b_AdminMetadata_languageOfCataloging_ss',
      // 'facet.field=Leader_06_typeOfRecord_ss',
      // 'facet.field=Leader_18_descriptiveCatalogingForm_ss'
  ];

  var facetLabels = {
      '041a_Language_ss': 'language',
      '040b_AdminMetadata_languageOfCataloging_ss': 'language of cataloging',
      'Leader_06_typeOfRecord_ss': 'record type',
      'Leader_18_descriptiveCatalogingForm_ss': 'cataloging form',
      '650a_Topic_topicalTerm_ss': 'topic',
      '650z_Topic_geographicSubdivision_ss': 'geographic',
      '650v_Topic_formSubdivision_ss': 'form',
      '6500_Topic_authorityRecordControlNumber_ss': 'topic id',
      '6510_Geographic_authorityRecordControlNumber_ss': 'geo id',
      '6550_GenreForm_authorityRecordControlNumber_ss': 'genre id',
      '9129_WorkIdentifier_ss': 'work id',
      '9119_ManifestationIdentifier_ss': 'manifestation id'
  };

  Handlebars.registerHelper('list', function(items, options) {
      var out = '<ul>';
      for(var i=0, l=items.length; i<l; i++) {
          out = out + '<li>' + options.fn(items[i]) + '</li>';
      }
      return out + '</ul>';
  });

  var recordTemplate      = Handlebars.compile($("#record-template").html());
  var listFacetTemplate   = Handlebars.compile($("#list-facet-template").html());
  var filterParamTemplate = Handlebars.compile($("#filter-param-template").html());
  var filterTemplate      = Handlebars.compile($("#list-filters-template").html());
  // var prevNextTemplate    = Handlebars.compile($("#list-prev-next-template").html());
  var itemPrevNextTemplate= Handlebars.compile($("#item-prev-next-template").html());
  var strong              = Handlebars.compile($("#strong-template").html());

  function getFacetLabel(facet) {
      if (typeof facetLabels[facet] != "undefined")
          return facetLabels[facet];
      return facet.replace(/_ss$/, '');
  }

  function buildFacetParameters() {
      var facetParameters = [];
      for (i in facets) {
          facetParameters.push('facet.field=' + facets[i]);
      }
      return facetParameters;
  }

  function buildUrl() {

      var url = baseUrl
          + '?q=' + query
          + '&' + parameters.join('&')
          + '&' + buildFacetParameters().join('&')
          + '&start=' + start
          + '&rows=' + rows;

      if (filters.length > 0)
          for (var i = 0; i < filters.length; i++)
              url += '&' + filters[i].param;

      return url;
  }

  function updateFilterBlock() {
      $('#filter-list').html(filterTemplate({'filters': filters}));
      $('#filter-list a').click(function (e) {
          var filter = $(this).attr('data');
          var index = -1;
          for (var i = 0; i < filters.length; i++) {
              if (filters[i].param == filter) {
                  index = i;
                  break;
              }
          }
          if (index != -1) {
              filters.splice(index, 1);
              start = 0;
              loadUrl(buildUrl());
          }
      })
  }

  function createPrevNextLinks(numFound) {
      $('#prev-next').html('');
      $('#prev-next-footer').html('');
      var items = [];
      var itemÃ©
      if (start > 0) {
          for (var i = 1; i <= 3; i++) {
              item = start - (i * rows);
              if (item >= 0)
                  items.unshift(itemPrevNextTemplate(
                      {'start': item, 'label': getInterval(item, numFound, false)}));
          }
      }
      items.push(strong({'item': getInterval(start, numFound, true)}));
      for (var i = 1; i <= 3; i++) {
          item = parseInt(start) + (i * rows);
          if (item+1 < numFound)
              items.push(itemPrevNextTemplate(
                  {'start': item, 'label': getInterval(item, numFound, false)}));
      }
      $('#prev-next').html(items.join(' &nbsp; '));
      $('#prev-next-footer').html(items.join(' &nbsp; '));
      $('#prev-next a').click(function (event) {
          event.preventDefault();
          start = $(this).attr('data');
          loadUrl(buildUrl());
      });
      $('#prev-next-footer a').click(function (event) {
          event.preventDefault();
          start = $(this).attr('data');
          loadUrl(buildUrl());
      });
  }

  function getInterval(number, max, both) {
      var beginning = parseInt(number) + 1;
      var startEnd = beginning + '-';
      if (both === true) {
          var ending = parseInt(number) + parseInt(rows);
          if (ending > max)
              ending = max;
          startEnd += ending;
      }
      return startEnd;
  }

  function processRecord(doc) {
      fields = [];
      for (var label in doc) {
          var value = doc[label];
          if (Object.prototype.toString.call(value) === '[object Array]'
              && value.length) {
              value = value[0];
          }

          fields.push({'label': label, 'value': value});
      }
      doc.fields = fields;

      doc.hasPublication = (
          typeof doc['260a_Publication_place_ss'] !== 'undefined'
          || typeof doc['260b_Publication_agent_ss'] !== 'undefined'
          || typeof doc['260c_Publication_date_ss'] !== 'undefined');
      doc.hasPhysicalDescription = (
          typeof doc['300a_PhysicalDescription_extent_ss'] !== 'undefined'
          || typeof doc['300c_PhysicalDescription_dimensions_ss'] !== 'undefined');
      doc.hasMainPersonalName = (
          typeof doc['100a_MainPersonalName_personalName_ss'] !== 'undefined'
          || typeof doc['100d_MainPersonalName_dates_ss'] !== 'undefined');
      doc.hasSimilarBooks = (
          typeof doc['9129_WorkIdentifier_ss'] !== 'undefined'
          || typeof doc['9119_ManifestationIdentifier_ss'] !== 'undefined');

      $('#records').append(recordTemplate(doc));
  }

  function processFacet(facetName, facet) {
      context = {
          'facetName': getFacetLabel(facetName),
          'machineName': facetName,
          'facets': []
      };
      for (var term in facet) {
          var count = facet[term];
          if (count > 0)
              context.facets.push({
                  'term': term,
                  'count': count //.toLocaleString('en-US')
              });
      }
      if (facetName == '9119_ManifestationIdentifier_ss'
          || facetName == '9129_WorkIdentifier_ss') {
          context.facets.sort(function(a,b) {
              return b.count - a.count;
          });
      }

      for (var i = 0; i < context.facets.length; i++) {
          item = context.facets[i];
          item.count = item.count.toLocaleString('en-US');
      }

      $('#facet-list').append(listFacetTemplate(context));
  }

  function setFacetClickBehaviour() {
      $('div.facet-block ul a').click(function (e) {
          var field = $(this).parent().parent().parent().attr('id');
          var value = $(this).html();
          var filterParam = filterParamTemplate({'field': field, 'value': value});
          filters.push({
              'param': filterParam,
              'label': getFacetLabel(field) + ': ' + value
          });
          start = 0;
          loadUrl(buildUrl());
      });
  }

  function loadUrl(urlParam) {
      $('#message').html('<i class="fa fa-spinner" aria-hidden="true"></i> loading...');
      // console.log('loading url: ' + urlParam);

      if (filters.length > 0) {
          updateFilterBlock();
      } else {
          $('#filter-list').html('');
      }

      $.getJSON(urlParam, function(result, status) {
          // console.log('loaded url: ' + urlParam);
          // console.log('status: ' + status);
          $('#numFound').html(result.response.numFound.toLocaleString('en-US'));
          $('#solr-url').html(urlParam);

          var numFound = result.response.numFound;
          createPrevNextLinks(numFound);

          $('#records').html('');
          $('#facet-list').html('');

          for (var i = 0; i < result.response.docs.length; i++) {
              processRecord(result.response.docs[i]);
          }
          showRecordDetails();

          for (var facetName in result.facet_counts.facet_fields) {
              processFacet(facetName, result.facet_counts.facet_fields[facetName]);
          }
          setFacetClickBehaviour();

          $('#message').html('');
      });
  }

  function showRecordDetails() {
      $('.record h2 a').click(function (event) {
          event.preventDefault();
          var detailsId = $(this).attr('data');
          console.log(detailsId);
          $('#' + detailsId).toggle();
      });

      $('.record-link').click(function (event) {
          event.preventDefault();
          var field = $(this).attr('data');
          var value = $(this).html();
          var filterParam = filterParamTemplate({'field': field, 'value': value});
          filters.push({
              'param': filterParam,
              'label': getFacetLabel(field) + ': ' + value
          });
          start = 0;
          loadUrl(buildUrl());
      });
  }

  function doSearch() {
      query = $('#query').val();
      start = 0;
      loadUrl(buildUrl());
  }

  function itemsPerPage() {
      var items = [];
      var numbers = [10, 25, 50, 100];
      for (var i in numbers) {
          var number = numbers[i];
          if (number === rows)
              items.push(strong({'item': number}));
          else
              items.push(itemPrevNextTemplate({
                  'start': number, 'label': number}));
      }
      $('#items-per-page').html(items.join(' '));
      $('#items-per-page a').click(function (event) {
          event.preventDefault();
          start = 0;
          rows = $(this).attr('data');
          itemsPerPage();
          loadUrl(buildUrl());
      });
  }

  function setFacets() {
      $('#records').html('<h3>Set facets</h3>');
      $.getJSON('listFields.php', function(result, status) {
          console.log('status: ' + status);
          var htmlForm = '<form id="facetselection">';
          for (item in result) {
              var facet = result[item];
              var isInUse = jQuery.inArray(facet, facets) > -1;
              var checked = isInUse ? ' checked="checked"' : '';
              htmlForm += '<input type="checkbox"'
                        + ' value="' + facet + '"'
                        + ' name="facet"'
                        + ' id="' + facet + '"'
                        + checked
                        + '> '
                        + '<label for="' + facet +'">' + facet + '</label><br/>'
              ;
          }
          htmlForm += '<input type="submit" value="save" id="save-facet-change" />';
          htmlForm += '</form>';
          $('#records').append(htmlForm);

          setFacetSelectionHandlers();
      });
  }

  function setFacetSelectionHandlers() {
      // $('#facet-selection :checkbox').change(function (){
      $('input[type="checkbox"]').change(function () {
          if (this.name == 'facet') {
              var facet = this.value;
              if (this.checked) {
                  facets.push(facet);
              } else {
                  var pos = jQuery.inArray(facet, facets);
                  if (pos > -1)
                      facets.splice(pos, 1);
              }
          }
      });

      $('#facetselection').submit(function(event) {
          event.preventDefault();
          var checkValues = $('input[name=facet]:checked').map(function() {
              return this.value;
          }).get().join(',');
          console.log(checkValues);

          $.post("saveFacets.php", {facet: checkValues}, function(result){
              console.log(result);
              $("#message").html("saved");
          });
          doSearch();
      });
  }

  function loadFacets() {
      $.getJSON('selected-facets.json', function(result, status) {
          if (result.length > 0)
              facets = result;
          else
              facets = defaultFacets;
          console.log('loadFacets/facets: ', facets);
      });
  }

  $(document).ready(function () {
      itemsPerPage();

      $('.fa-search').click(function (event) {
          doSearch();
      });
      $('#search').submit(function (event) {
          event.preventDefault();
          doSearch();
      });
      $('#set-facets').click(function (event) {
          event.preventDefault();
          setFacets();
      });
      // loadFacets();
      console.log('main/facets: ', facets);
      console.log('main/defaultFacets: ', defaultFacets);
      loadUrl(buildUrl());
   });
</script>
</body>
</html>